{% extends 'base.html' %} {% block content %}

{% load static %}

<div class="main-wrapper">
  <div class="page-wrapper">
    <div class="content container-fluid">
      <div class="page-header">
        <div class="row align-items-center">
          <div class="col">
            <h3 class="page-title">Add Invoice</h3>
            <ul class="breadcrumb">
              <li class="breadcrumb-item">
                <a href="{% url 'finance_dashboard' %}">Dashboard</a>
              </li>
              <li class="breadcrumb-item active">Add Invoice</li>
            </ul>
          </div>
          <div class="col-auto text-right float-right ml-auto">
            <a href="{% url 'view_invoices' %}" class="btn btn-primary"
              ><i class="fas fa-plus"></i> &nbsp;View Invoice
            </a>
          </div>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col-sm-12">
        <div class="card">
          <div class="card-body">
            <form method="post" action="#">
              {% csrf_token %}
              <div class="col-12">
                <h5 class="form-title"><span>Add Invoice</span></h5>
              </div>
              {% include 'includes/messages.html' %}
              <div class="row col-12">
                <div class="col-12 col-sm-6">
                  <div class="form-group">
                    <label>Invoice No</label>
                    <input
                      required
                      type="text"
                      class="form-control"
                      name="invoice_no"
                      id="invoice_no"
                      value="{{invoice.invoice_no}}"
                      disabled
                    />
                  </div>
                </div>
                <div class="col-12 col-sm-6">
                  <div class="form-group">
                    <label>Date</label>
                    <input
                      required
                      type="date"
                      class="form-control"
                      name="date"
                      id="date"
                      value="{{year}}-{{month}}-{{day}}"
                    />
                  </div>
                </div>
              </div>
              <div class="col-12 col-sm-6">
                <div class="form-group">
                  <label>Customer</label>
                  <select id="customers_select" name="customer_id">
                    <option>Select Customer</option>
                    {% for i in customers %}
                    <option value="{{i.id}}" {% if i.id == invoice.customer.id %} selected{% endif %} >
                      {{i.name}}
                      {{i.address}}
                    </option>
                    {% endfor %}
                  </select>
                </div>
              </div>
              <div class="change_shipping_address col-sm-6 col-12 my-3">
                <div class="form-check form-check-inline">
                  <label class="form-check-label" style="user-select: none;cursor: pointer;color: green;">
                    <input class="form-check-input" type="checkbox" name="change_shipping_address" id="change_shipping_address" value="checkedValue"> Change Shipping Address
                  </label>
                </div>
              </div>
              <div class="random_customer col-sm-12">
                <div class="row">
                  <div class="form-group col-sm-6">
                    <label>Customer name</label>
                    <input
                      type="text"
                      class="form-control remove_from_random_customer"
                      name="customer_name"
                      id="shipping_customer_name"
                      value=""
                    />
                  </div>
                  <div class="form-group col-sm-6">
                    <label for="state">State</label>
                    <select name="state" class="form-control" id="shipping_state">
                      {% for i in states %}
                        <option value="{{forloop.counter}}">{{i}}</option>
                      {% endfor %}
                    </select>
                  </div>
                </div>
                <div class="form-group">
                  <label>Address</label>
                  <textarea
                    class="form-control remove_from_random_customer"
                    name="address"
                    id="shipping_address"
                    rows="10"
                  ></textarea>
                </div>
              </div>

              <table class="table mt-4 table-striped table-responsive" id="myTable">
                <thead>
                  <tr>
                    <th width="300">Item</th>
                    <th>Tax (in %)</th>
                    <th width="99">Quantity</th>
                    <th width="150">Rate</th>
                    <th width="99">Discount (in %)</th>
                    <th>Taxable Value</th>
                    <th class="text-right">Action</th>
                  </tr>
                </thead>
                <tbody>
					        {% for transaction in transactions %}
                    <tr>
                      <td>
                        <textbox rows="10" columns="10" >{{transaction.item.name}}</textbox>
                      </td>
                      <td>
                        {{transaction.item.state_tax_rate}}% / {{transaction.item.state_tax_rate}}%
                      </td>
                      <td>
                        <input
                          required
                          type="number" step="0.01"
                          class="form-control"
                          name="qnt"
                          disabled
                          value="{{transaction.quantity}}"
                        />
                      </td>
                      <td>
                        <input
                          required
                          type="number" step="0.01"
                          class="form-control"
                          name="rate"
                          disabled
                          value="{{transaction.rate}}"
                        />
                      </td>
                      <td>
                        <input
                          required
                          type="number" step="0.01"
                          class="form-control"
                          name="discount"
                          value="{{transaction.discount_percent}}"
                          disabled
                        />
                      </td>
                      <td>
                        <input
                          required
                          type="number" step="0.01"
                          class="form-control"
                          name="rate"
                          disabled
                          value="{{transaction.taxable_value}}"
                        />
                      </td>
                      <td class="text-right">
                        <div class="actions">
                          
                          <button type="button" class="btn btn-sm bg-info-light mr-2 edit_transaction_button" info="{{transaction.id}}" data-toggle="modal" data-target="#editTransaction">
                            <i class="fas fa-pen"></i>
                        </button>

                          <a
                            href="{% url 'delete_transaction' transaction.id %}"
                            class="btn btn-sm bg-danger-light mr-2"
                          >
                            <i class="fas fa-trash"></i>
                          </a>
                          
                          
                        </div>
                      </td>
                    </tr>
                  {% endfor %}
                  
                </tbody>
                <tfoot>
                  <tr>
                    <td colspan="2">
                      <button
                      type="button" class="btn btn-primary" id="add_item" data-toggle="modal" data-target="#addItem"
                      >
                        <i class="fa fa-plus"></i>&nbsp; Add Item
                      </button>
                      
                    </td>
                  </tr>
                  <tr>
                    <td colspan="2"></td>
                    <td class="text-end" colspan="2"><strong>Total Taxable Amount:</strong></td>
                    <td colspan="1"></td>
                    <td align="right"><b>{{invoice.total_taxable_amount}}</b></td>
                    <td></td>
                  </tr>
                  <tr>
                    <td colspan="2"></td>
                    <td class="text-end" colspan="2"><strong>CGST:</strong></td>
                    <td colspan="1"></td>
                    <td align="right"><b>{{invoice.total_central_tax_amount}}</b></td>
                  </tr>
                  <tr>
                    <td colspan="2"></td>
                    <td class="text-end" colspan="2"><strong>SGST:</strong></td>
                    <td colspan="1"></td>
                    <td align="right"><b>{{invoice.total_state_tax_amount}}</b></td>
                  </tr>
                  <tr>
                    <td colspan="2"></td>
                    <td class="text-end" colspan="2"><strong>IGST:</strong></td>
                    <td colspan="1"></td>
                    <td align="right"><b>{{invoice.total_integrated_tax_amount}}</b></td>
                  </tr>
                  {% for u,v in extra_details.items %}
                    <tr>
                      <td colspan="2"></td>
                      <td class="text-end" colspan="2"><strong>{{u}}</strong></td>
                      <td colspan="1"></td>
                      {% comment %} Make it a number {% endcomment %}
                      <td align="right"><b>{{v|floatformat:2}}</b></td>
                      <td>
                        <a href="" class="btn btn-primary"><i class="fas fa-trash"></i></a>
                      </td>
                    </tr>
                  {% endfor %}
                  <tr>
                    <td colspan="2">
                      <button
                      type="button" class="btn btn-secondary" id="add_item" data-toggle="modal" data-target="#addTransaction"
                      >
                        <i class="fa fa-plus"></i>&nbsp; Add Transaction
                      </button>
                      
                    </td>
                  </tr>
                  <tr>
                    <td colspan="4"></td>
                    <td colspan="2" align="right" style="
                    font-size: x-large;
                    color: green;
                    font-weight: 400;
                    "><b>{{invoice.total_amount}}</b></td>
                  </tr>
                </tfoot>
              </table>
              <div class="row">
                <div class="col-sm-2">
                  <button type="submit" class="btn btn-primary">
                    Save Invoice
                  </button>
                </div>
                <div class="col-sm-2">
                  <button type="button" class="btn btn-secondary">
                    Preview Invoice
                  </button>
                </div>
                <div class="col-sm-2">
                  <a href="{% url 'reset_invoice' %}" class="btn btn-danger" id="reset">
                    Reset
                  </a>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>


<!-- Modal For Creating transaction-->
<div class="modal fade" id="addItem" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">Add Item</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form id="modal-form" method="post" action="">
          {% csrf_token %}
          
          <div class="row col-12">
            <div class="col-12 col-sm-3">
              <div class="form-group">  
                <label for="item">Item</label>
                <select id="items_select" name="item">
                  <option>Select Item</option>
                  {% for i in items %}
                  <option value="{{i.id}}" current_stock="{{i.current_stock}}" tax="{{i.state_tax_rate}}">
                    {{i.name}} 
                  </option>
                  {% endfor %}
                </select>
              </div>
            </div>
            <div class="col-12 col-sm-1">
              <label>Edit</label>
              <a href="/finance/edit_items/1/" target="_blank" id="edit_item" class="btn btn-sm bg-success-light mr-2">
                <i class="fas fa-pen"></i>
              </a>
            </div>
            <div class="col-12 col-sm-2">
              <div class="form-group">
                <label>Tax Percent</label>
                <input
                  required
                  type="number" step="0.01"
                  class="form-control"
                  name="tax" id="tax"
                  disabled
                />
              </div>
            </div>
            <div class="col-12 col-sm-3">
              <div class="form-group">
                <label>Current Stock</label>
                <input
                  required
                  type="number" step="0.01"
                  class="form-control"
                  id="current_stock"
                  disabled
                />
              </div>
            </div>
            <div class="col-12 col-sm-3">
              <div class="form-group">
                <label>Quantity</label>
                <input
                  required
                  type="number" step="0.01"
                  class="form-control"
                  name="qnt" id="qnt"
                />
              </div>
            </div>
            <div class="col-12 col-sm-6">
              <div class="form-group">
                <label>Rate (Excluding Tax)</label>
                <input
                  required
                  type="number" step="0.01"
                  class="form-control"
                  name="rate" id="rate"
                />
              </div>
            </div>
            <div class="col-12 col-sm-6">
              <div class="form-group">
                <label>Taxable Value</label>
                <input
                  required
                  type="number" step="0.01"
                  class="form-control"
                  name="taxable_value" id="taxable_value"
                />
              </div>
            </div>
            <div class="col-12 col-sm-6">
              <div class="form-group">
                <label>Discount (in %)</label>
                <input
                  required
                  type="number" step="0.01"
                  class="form-control"
                  name="discount_percent" id="discount_percent"
                />
              </div>
              <div class="form-group">
                <label>Rate (Including Tax)</label>
                <input
                  required
                  type="number" step="0.01"
                  class="form-control"
                  name="total_rate" id="total_rate"
                />
            </div>
              
            </div>

            <div class="col-12 col-sm-6">
              <div class="form-group">
                <label>Discount Amount</label>
                <input
                  required
                  type="number" step="0.01"
                  class="form-control"
                  name="discount_amount" id="discount_amount"
                />
              </div>
              <div class="form-group">
                <label>Total Amount</label>
                <input
                  required
                  type="number" step="0.01"
                  class="form-control"
                  name="total_amount" id="total_amount"
                />
              </div>
            
              
            </div>
            <input type="hidden" name="invoice_id" value="{{invoice.id}}">
            <input type="hidden" name="customer_id_in_transaction" id="customer_id_in_transaction" value="2">
            <input type="hidden" name="shipping_checkbox_trxn" id="shipping_checkbox_trxn" value="0">
            <input type="hidden" name="shipping_state_trxn" id="shipping_state_trxn" value="26">
          </div>
        
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-success">Add</button>
      </div>
    </div>
  </form>
  </div>
</div>



<form action="" method="post">
  {% csrf_token %}
<!-- Extra Details in Invoice (Discount, Round etc) Modal-->
<div class="modal fade" id="addTransaction" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">Add Item</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
          <div class="row col-12">
            <div class="form-group col-sm-12">
              <label for="taxable_value_in_trxn">Total Taxable Value</label>
              <input type="text" class="form-control" name="taxable_value_in_trxn" aria-describedby="helpId" value="{{invoice.total_taxable_amount}}" disabled>
            </div>
            <div class="form-group col-sm-4">
              <input placeholder="Name" type="text" class="form-control" name="name_in_trxn" aria-describedby="helpId" >
            </div>
            <div class="form-group col-sm-4">
              <input placeholder="Percent" type="number" step="0.01" class="form-control" name="percent_in_trxn" aria-describedby="helpId" >
            </div>
            <div class="form-group col-sm-4">
              <input placeholder="Amount" type="number" step="0.01" class="form-control" name="amount_in_trxn" aria-describedby="helpId" >
            </div>
            <div class="form-group col-sm-12">
              <label for="total_amount_in_trxn">Total Amount</label>
              <input type="number" steps="0.01" class="form-control" name="total_amount_in_trxn" aria-describedby="helpId" value="{{invoice.total_amount}}" disabled>
            </div>
          </div>
        
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-success">Add</button>
      </div>
    </div>
  </div>
</div>
</form>

<!-- Modal To Edit the Transaction-->
<div class="modal fade" id="editTransaction" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel2" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel2">Edit Transaction</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form id="modal-form2" method="post" action="/finance/save_edit_transaction/1">
          {% csrf_token %}
          
          <div class="row col-12">
            <div class="col-12 col-sm-3">
              <div class="form-group">  
                <label for="item">Item</label>
                <select id="items_select2" name="item" >
                  <option>Select Item</option>
                  {% for i in items %}
                  <option value="{{i.id}}" current_stock="{{i.current_stock}}" tax="{{i.state_tax_rate}}">
                    {{i.name}}
                  </option>
                  {% endfor %}
                </select>
              </div>
            </div>
            <div class="col-12 col-sm-1">
              <label>Edit</label>
              <a href="/finance/edit_items/1/" target="_blank" id="edit_item2" class="btn btn-sm bg-success-light mr-2">
                <i class="fas fa-pen"></i>
              </a>
            </div>
            <div class="col-12 col-sm-2">
              <div class="form-group">
                <label>Tax Percent</label>
                <input
                  required
                  type="number" step="0.01"
                  class="form-control"
                  name="tax" id="tax2"
                  disabled
                />
              </div>
            </div>
            <div class="col-12 col-sm-3">
              <div class="form-group">
                <label>Current Stock</label>
                <input
                  required
                  type="number" step="0.01"
                  class="form-control"
                  id="current_stock2"
                  disabled
                />
              </div>
            </div>
            <div class="col-12 col-sm-3">
              <div class="form-group">
                <label>Quantity</label>
                <input
                  required
                  type="number" step="0.01"
                  class="form-control"
                  name="qnt" id="qnt2"
                />
              </div>
            </div>
            <div class="col-12 col-sm-6">
              <div class="form-group">
                <label>Rate (Excluding Tax)</label>
                <input
                  required
                  type="number" step="0.01"
                  class="form-control"
                  name="rate" id="rate2"
                />
              </div>
            </div>
            <div class="col-12 col-sm-6">
              <div class="form-group">
                <label>Taxable Value</label>
                <input
                  required
                  type="number" step="0.01"
                  class="form-control"
                  name="taxable_value" id="taxable_value2"
                />
              </div>
            </div>
            <div class="col-12 col-sm-6">
              <div class="form-group">
                <label>Discount (in %)</label>
                <input
                  required
                  type="number" step="0.01"
                  class="form-control"
                  name="discount_percent" id="discount_percent2"
                />
              </div>
                  <div class="form-group">
                    <label>Rate (Including Tax)</label>
                    <input
                      required
                      type="number" step="0.01"
                      class="form-control"
                      name="total_rate" id="total_rate2"
                    />
                </div>
              
            </div>

            <div class="col-12 col-sm-6">
              <div class="form-group">
                <label>Discount Amount</label>
                <input
                  required
                  type="number" step="0.01"
                  class="form-control"
                  name="discount_amount" id="discount_amount2"
                />
              </div>
              <div class="form-group">
                <label>Total Amount</label>
                <input
                  required
                  type="number" step="0.01"
                  class="form-control"
                  name="total_amount" id="total_amount2"
                />
              </div>
            
              
            </div>
            <input type="hidden" name="invoice_id" value="{{invoice.id}}">
            <input type="hidden" name="customer_id_in_transaction" id="customer_id_in_transaction2" value="2">
          </div>
        
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-info">Update</button>
      </div>
    </div>
  </div>
</div>
</form>
{% endblock content %}

{% block script %}
<script>
  const checkbox_input = document.querySelector("input#change_shipping_address")
  function checkCheckbox()
  {
    data = sessionStorage.getItem("checked_shipping")
      if(data == 'true')
      {
        console.log('click') 
        if(!checkbox_input.checked)
          checkbox_input.click();
        node.style.display="block" 
        
      }
      else if(data == 'false')
      {
        console.log('click 2')
        if (checkbox_input.checked)
          checkbox_input.click();
        node.style.display="none" 
      }
  }
  {% comment %} document.querySelector('input#change_shipping_address').checked = true {% endcomment %}
function change_tax(name)
  {
    if(name == "IGST")
    {
      console.log("Ran IGST")
      changeInvoiceState("IGST")
    }
    else if(name == "CGST" || name == "SGST" || name == "OGST")
    {
      console.log("Ran CGST")
      changeInvoiceState("CGST")
    }
    else
      console.error("Not accepted this GST: ",name);
  };
CUSTOMER_IS_CASH = false ;
console.log("Started")
</script>
<script src="{% static 'assets/js/add_invoice.js' %}"></script>
console.log("Heading over")
<script>
  // cash customer check 
  function checkIfCash(value)
  {
    if(value == {{cash_id}})
    {
      update_random_customer(1);
      CUSTOMER_IS_CASH = true
    }
    else 
    {
      update_random_customer(3)
      CUSTOMER_IS_CASH = false
    }
  }
  $(function () {
    $("#customers_select").selectize({
      onChange: function(value) {
        // Make an AJAX request to fetch the available quantity
        checkIfCash(value)
        getCustomerState(value)
        sessionStorage.setItem('cust_sel',value) 
        customer_id_in_transaction.value = value
        customer_id_in_transaction2.value = value
        
        }
    });
  });
  checkIfCash(document.getElementById("customers_select").value);

  // ----------------------------------------------------------------------------------------------------
  // SHIPPING 

  state = document.getElementById("shipping_state")
  state.addEventListener("change",
    (e)=>{
    // the first condition is for that check only if its tick on checkbox 
    // this is to preserve the bug when the box is not checked but still giving changing Stuffs
    if(sessionStorage.getItem("checked_shipping") == "true" && state.value != {{my_state_value}})
      // its an IGST 
      change_tax("IGST");
    else if (CUSTOMER_IS_CASH == true && state.value != {{my_state_value}})
      //its an IGST 
      change_tax("IGST");
    else  
      // its an CGST
      change_tax("CGST");  
  });
  console.log("Ended")

  add_item_button = document.getElementById("add_item")
  add_item_button.addEventListener("click",(e)=>{

      data = sessionStorage.getItem('checked_shipping')
      if(data && data == 'true') shipping_checkbox_trxn.value = "1";
      else shipping_checkbox_trxn.value = "0";

      data = sessionStorage.getItem('state')
      if(data)
        shipping_state_trxn.value = data
      
  })
  document.addEventListener("DOMContentLoaded",(e)=>{
    checkCheckbox()
      
  });

  // adding event listener to percent input to update amount input in addTransaction
  percent_input = document.querySelector("input[name='percent_in_trxn']")
  amount_input = document.querySelector("input[name='amount_in_trxn']")
  total_amount_input = document.querySelector("input[name='total_amount_in_trxn']")
  percent_input.addEventListener("input",(e)=>{
    amount_input.value = round((percent_input.value/100)*document.querySelector("input[name='taxable_value_in_trxn']").value);
    total_amount_input.value = round(parseFloat(total_amount_input.value) + parseFloat(amount_input.value)) ;
  })

  // adding event listener to amount input to update percent input in addTransaction
  amount_input.addEventListener("input",(e)=>{
    if(amount_input.value && parseFloat(amount_input.value))
      percent_input.value = round((amount_input.value/document.querySelector("input[name='taxable_value_in_trxn']").value)*100);
    else
      percent_input.value = 0;
    total_amount_input.value = round(parseFloat({{invoice.total_amount}}) + parseFloat(amount_input.value)) ;
  })

</script>
{% endblock script %}